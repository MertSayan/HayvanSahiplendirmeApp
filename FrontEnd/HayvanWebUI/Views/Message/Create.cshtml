@{
    ViewData["Title"] = "Mesajlaş";
    Layout = "~/Views/UILayout/Index.cshtml";
    var receiverId = ViewBag.ReceiverId;
}
<style>
    .bubble-in {
        background-color: #e0e0e0; /* önceki: #f1f1f1 */
        color: #333;
        max-width: 75%;
    }

    .bubble-out {
        background-color: #ff7f32;
        color: white;
        max-width: 75%;
    }

    .bubble-in, .bubble-out {
        border-radius: 12px;
        padding: 10px 15px;
        word-wrap: break-word;
    }

    #messageArea {
        background: #fff;
        padding: 10px;
        height: 500px;
        overflow-y: auto;
    }
</style>

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div id="chat-box" class="border p-4 rounded shadow-sm">
                <h4 class="mb-4">Kullanıcı ile Mesajlaş</h4>

                <div id="messageArea" class="mb-3" style="height: 400px; overflow-y: auto; background: #f1f1f1; padding: 10px;">
                    <!-- Mesajlar buraya gelir -->
                </div>

                <div class="input-group">
                    <input type="text" id="messageInput" class="form-control" placeholder="Mesaj yaz...">
                    <button id="sendBtn" class="btn btn-primary">Gönder</button>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {


    <script>
        const receiverId = @receiverId;

        document.getElementById("sendBtn").addEventListener("click", function () {
            const message = document.getElementById("messageInput").value;
            if (message.trim() !== "") {
                sendMessageToUser(receiverId, message);
                document.getElementById("messageInput").value = "";

                const messageArea = document.getElementById("messageArea");
                messageArea.scrollTop = messageArea.scrollHeight;
            }
        });

        if (window.connection) {
            window.connection.on("ReceiveMessage", function (senderId, messageText) {
                const messageArea = document.getElementById("messageArea");
                messageArea.scrollTop = messageArea.scrollHeight;
            });
        }

        // ✅ Sohbet açıldığında geçmiş mesajları getir
        $(document).ready(function () {
            const userId = parseInt(localStorage.getItem("userId"));

            $.get(`https://localhost:7160/api/Messages/GetConversation?userId1=${userId}&userId2=${receiverId}`, function (data) {
                const messageArea = document.getElementById("messageArea");
                messageArea.innerHTML = "";

                data.forEach(msg => {
                    const isMine = msg.senderId === userId;
                    const alignmentClass = isMine ? "message-out" : "message-in";
                    const bubbleColor = isMine ? "bubble-out" : "bubble-in";
                    const time = new Date(msg.createdAt).toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', year: 'numeric' });

                    messageArea.innerHTML += `
                <div class="d-flex ${isMine ? 'justify-content-end' : 'justify-content-start'} mb-2">
                    <div class="${bubbleColor} p-2 rounded">
                        <div>${msg.messageText}</div>
                        <div class="text-end small text-muted mt-1">${time}</div>
                    </div>
                </div>
            `;
                });

                messageArea.scrollTop = messageArea.scrollHeight;
            });
        });


    </script>
}
